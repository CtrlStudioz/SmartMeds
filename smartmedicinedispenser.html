<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Medicine Dispenser Control</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a0ca3;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #ef233c;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 16px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            --box-shadow-hover: 0 8px 24px rgba(0,0,0,0.12);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            padding: 10px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Main Container */
        .app-container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            min-height: calc(100vh - 20px);
            display: flex;
            flex-direction: column;
        }
        
        /* Header - Mobile Optimized */
        .app-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 20px 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo-icon {
            font-size: 2rem;
            background: rgba(255,255,255,0.2);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .app-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
            line-height: 1.3;
            margin: 0;
        }
        
        .app-subtitle {
            font-size: 0.85rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .connection-status {
            background: rgba(255,255,255,0.2);
            padding: 8px 15px;
            border-radius: 50px;
            font-size: 0.8rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Status Cards - Mobile Grid */
        .status-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--box-shadow);
            transition: transform 0.2s ease;
            border-left: 4px solid var(--primary);
        }
        
        .status-card:active {
            transform: scale(0.98);
        }
        
        .status-icon {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .status-label {
            font-size: 0.75rem;
            color: var(--gray);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--dark);
            line-height: 1.2;
        }
        
        /* Refill Warning Banner */
        .refill-warning-banner {
            background: linear-gradient(135deg, #ff6b6b, #ff9a00);
            color: white;
            border-left: 4px solid #ff0000;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        
        .refill-warning-icon {
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }
        
        .refill-warning-text h6 {
            font-weight: 700;
            margin: 0;
            color: white;
        }
        
        .refill-warning-text p {
            font-size: 0.85rem;
            margin: 5px 0 0;
            color: white;
            opacity: 0.9;
        }
        
        /* Warning Banner */
        .warning-banner {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .warning-icon {
            font-size: 1.5rem;
            color: #ff9800;
            flex-shrink: 0;
        }
        
        .warning-text h6 {
            font-weight: 700;
            margin: 0;
            color: #856404;
        }
        
        .warning-text p {
            font-size: 0.85rem;
            margin: 5px 0 0;
            color: #856404;
            opacity: 0.9;
        }
        
        /* Section Headers */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .section-icon {
            font-size: 1.3rem;
            color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .section-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            font-size: 1.2rem;
            color: var(--dark);
            margin: 0;
        }
        
        /* Action Buttons */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .action-btn {
            background: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 18px 12px;
            box-shadow: var(--box-shadow);
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 100px;
        }
        
        .action-btn:active {
            transform: scale(0.98);
            box-shadow: var(--box-shadow-hover);
        }
        
        .action-btn.dispense {
            background: linear-gradient(135deg, var(--success), #2a9d8f);
            color: white;
        }
        
        .action-btn.test {
            background: linear-gradient(135deg, #ff9a00, #ff6b6b);
            color: white;
        }
        
        .action-btn.reset {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }
        
        .action-btn.sanitizer {
            background: linear-gradient(135deg, #7209b7, #3a0ca3);
            color: white;
        }
        
        .action-btn.refill {
            background: linear-gradient(135deg, #ff6b6b, #ff9a00);
            color: white;
        }
        
        .action-icon {
            font-size: 1.8rem;
        }
        
        .action-label {
            font-weight: 600;
            font-size: 0.9rem;
            text-align: center;
            line-height: 1.2;
        }
        
        /* Compartment Buttons */
        .compartment-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .compartment-btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: 12px;
            padding: 15px 5px;
            font-weight: 700;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
            min-height: 80px;
        }
        
        .compartment-btn:active {
            transform: scale(0.95);
            box-shadow: var(--box-shadow-hover);
        }
        
        .compartment-btn.hole {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--gray), #495057);
        }
        
        .compartment-btn.calibrate {
            grid-column: span 2;
            background: linear-gradient(135deg, var(--danger), #d90429);
        }
        
        .compartment-icon {
            font-size: 1.5rem;
        }
        
        .compartment-label {
            font-size: 0.85rem;
            opacity: 0.9;
        }
        
        /* Manual Controls */
        .manual-controls {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        .manual-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .manual-btn {
            background: white;
            border: 2px solid var(--primary);
            color: var(--primary);
            border-radius: 12px;
            padding: 12px 5px;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .manual-btn:active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }
        
        .manual-icon {
            font-size: 1.2rem;
        }
        
        /* Emergency Stop */
        .emergency-container {
            margin: 20px 0;
        }
        
        .emergency-btn {
            background: linear-gradient(135deg, var(--danger), #d00000);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 20px;
            font-weight: 700;
            font-size: 1.1rem;
            width: 100%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 6px 20px rgba(239, 35, 60, 0.3);
        }
        
        .emergency-btn:active {
            transform: scale(0.98);
            box-shadow: 0 4px 15px rgba(239, 35, 60, 0.4);
        }
        
        /* ===== CLEAN MEDICATION LOG SECTION ===== */
        .medicine-log-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--box-shadow);
            flex: 1;
            display: flex;
            flex-direction: column;
            max-height: 500px;
        }
        
        .medicine-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .medicine-log-title {
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .medicine-log-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .medicine-log-badge {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .medicine-log-table-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            border-radius: 12px;
            background: var(--light);
            padding: 1px;
        }
        
        .medicine-log-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            font-size: 0.9rem;
        }
        
        .medicine-log-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .medicine-log-table th {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }
        
        .medicine-log-table th:first-child {
            border-top-left-radius: 10px;
        }
        
        .medicine-log-table th:last-child {
            border-top-right-radius: 10px;
        }
        
        .medicine-log-table td {
            padding: 15px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            background: white;
            color: var(--dark);
        }
        
        .medicine-log-table tbody tr {
            transition: all 0.2s ease;
        }
        
        .medicine-log-table tbody tr:hover {
            background: rgba(76, 201, 240, 0.05);
            transform: translateX(2px);
        }
        
        .medicine-log-table tbody tr:last-child td {
            border-bottom: none;
        }
        
        .medicine-log-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 10px;
        }
        
        .medicine-log-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 10px;
        }
        
        .log-timestamp {
            font-weight: 600;
            color: var(--primary);
            min-width: 150px;
        }
        
        .log-time-details {
            color: var(--gray);
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .log-day {
            font-weight: 600;
            color: var(--dark);
        }
        
        .log-time {
            display: block;
            font-family: monospace;
            background: rgba(0,0,0,0.02);
            padding: 4px 8px;
            border-radius: 4px;
            margin-top: 4px;
        }
        
        .log-status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid #4cc9f0;
        }
        
        .log-days-ago {
            font-size: 0.8rem;
            color: var(--gray);
            margin-top: 5px;
            font-style: italic;
        }
        
        .no-medicine-log {
            text-align: center;
            padding: 60px 20px;
            color: var(--gray);
        }
        
        .no-medicine-log i {
            font-size: 3rem;
            margin-bottom: 20px;
            color: #4cc9f0;
            opacity: 0.3;
        }
        
        .no-medicine-log p {
            margin: 5px 0;
        }
        
        /* Loading Spinner */
        .loading-spinner {
            display: none;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Touch-friendly improvements */
        @media (hover: hover) {
            .action-btn:hover,
            .compartment-btn:hover,
            .manual-btn:hover {
                transform: translateY(-2px);
                box-shadow: var(--box-shadow-hover);
            }
            
            .status-card:hover {
                transform: translateY(-2px);
            }
            
            .emergency-btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 25px rgba(239, 35, 60, 0.4);
            }
        }
        
        /* Day selector enhancements - RESPONSIVE FIX */
        .day-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .day-btn {
            flex: 1;
            min-width: 40px;
            padding: 8px 0;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid var(--primary);
            transition: all 0.2s ease;
            text-align: center;
        }
        
        .day-btn:active {
            transform: scale(0.95);
        }
        
        .btn-outline-primary {
            background: white;
            color: var(--primary);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }
        
        /* Quick select buttons styling */
        .quick-select-buttons .btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .quick-select-buttons .btn i {
            font-size: 0.8rem;
        }
        
        /* Schedule form validation styling */
        .form-control:invalid {
            border-color: var(--danger);
        }
        
        .form-control:focus:invalid {
            box-shadow: 0 0 0 0.2rem rgba(239, 35, 60, 0.25);
        }
        
        /* Schedule item styles - REMOVED BADGES */
        .schedule-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            transition: all 0.3s ease;
        }
        
        .schedule-item.active-schedule {
            border-left-color: #4cc9f0;
        }
        
        .schedule-item.inactive-schedule {
            border-left-color: var(--gray);
            opacity: 0.7;
        }
        
        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .schedule-name {
            font-weight: 700;
            font-size: 1rem;
            color: var(--dark);
        }
        
        .schedule-time {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }
        
        .schedule-details {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .schedule-days {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(67, 97, 238, 0.1);
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: var(--primary);
        }
        
        .schedule-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        
        .schedule-status-badge.active {
            background: rgba(76, 201, 240, 0.2);
            color: #4cc9f0;
            border: 1px solid #4cc9f0;
        }
        
        .schedule-status-badge.inactive {
            background: rgba(108, 117, 125, 0.2);
            color: var(--gray);
            border: 1px solid var(--gray);
        }
        
        .schedule-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }
        
        .schedule-actions button {
            flex: 1;
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 8px;
        }
        
        .no-schedules {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }
        
        .no-schedules i {
            color: var(--primary);
            opacity: 0.5;
        }
        
        /* Badge styles */
        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }
        
        /* Quick select buttons - RESPONSIVE FIX */
        .quick-select-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        
        .btn-outline-secondary {
            border-color: #dee2e6;
            color: var(--gray);
        }
        
        .btn-outline-secondary:hover {
            background: #f8f9fa;
        }
        
        /* Schedule form improvements */
        .schedule-form-container {
            background: var(--light);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
        }
        
        /* Refill button */
        .refill-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff9a00);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 15px;
            font-weight: 600;
            font-size: 1rem;
            width: 100%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .refill-btn:active {
            transform: scale(0.98);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }
        
        /* NEW: Improved Time Picker Styles */
        .time-picker-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .time-picker-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .time-display {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            padding: 10px;
            background: rgba(67, 97, 238, 0.1);
            border-radius: var(--border-radius);
            min-width: 120px;
        }
        
        .time-sliders {
            margin-top: 20px;
        }
        
        .time-slider-group {
            margin-bottom: 25px;
        }
        
        .time-slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 10px;
        }
        
        .time-slider-label span {
            font-weight: 600;
            color: var(--dark);
            min-width: 50px;
        }
        
        .time-slider-label .value {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.2rem;
            min-width: 40px;
            text-align: center;
        }
        
        .time-controls {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        
        .time-control-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .time-control-btn:active {
            transform: scale(0.9);
            background: var(--primary-dark);
        }
        
        .time-slider {
            width: 100%;
            height: 8px;
            -webkit-appearance: none;
            appearance: none;
            background: #e0e0e0;
            border-radius: 4px;
            outline: none;
        }
        
        .time-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .time-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        
        .quick-time-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-top: 15px;
        }
        
        .quick-time-btn {
            padding: 10px 5px;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 8px;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .quick-time-btn i {
            font-size: 0.8rem;
        }
        
        .quick-time-btn:active {
            background: var(--primary);
            color: white;
            transform: scale(0.95);
        }
        
        .am-pm-toggle {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .am-pm-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
        }
        
        .am-pm-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }
        
        .am-pm-btn:active {
            transform: scale(0.95);
        }
        
        /* ===== MODAL STYLES ===== */
        .confirmation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 450px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .modal-header {
            padding: 25px 25px 15px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
        }
        
        .modal-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: white;
        }
        
        .modal-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 1.4rem;
            margin: 0 0 8px 0;
        }
        
        .modal-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-message {
            font-size: 1rem;
            line-height: 1.5;
            color: var(--dark);
            margin-bottom: 25px;
            text-align: center;
        }
        
        .modal-footer {
            padding: 0 25px 25px;
            display: flex;
            gap: 12px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .modal-btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .modal-btn-secondary {
            background: #f8f9fa;
            color: var(--gray);
            border: 2px solid #e0e0e0;
        }
        
        .modal-btn-danger {
            background: linear-gradient(135deg, var(--danger), #d00000);
            color: white;
            box-shadow: 0 4px 12px rgba(239, 35, 60, 0.3);
        }
        
        .modal-btn-warning {
            background: linear-gradient(135deg, #ff9a00, #ff6b6b);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 154, 0, 0.3);
        }
        
        .modal-btn:active {
            transform: scale(0.98);
        }
        
        /* Modal for clear all schedules */
        .clear-schedules-modal .modal-header {
            background: linear-gradient(135deg, var(--danger), #d00000);
        }
        
        /* Modal for refill */
        .refill-modal .modal-header {
            background: linear-gradient(135deg, #ff6b6b, #ff9a00);
        }
        
        /* Modal for calibration */
        .calibration-modal .modal-header {
            background: linear-gradient(135deg, #4cc9f0, #2a9d8f);
        }
        
        /* Modal for delete schedule */
        .delete-schedule-modal .modal-header {
            background: linear-gradient(135deg, var(--danger), #d00000);
        }
        
        /* Tablet and Desktop Optimizations */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .app-container {
                max-width: 750px;
            }
            
            .app-header {
                padding: 25px 30px;
            }
            
            .app-title {
                font-size: 1.8rem;
            }
            
            .main-content {
                padding: 25px;
            }
            
            .status-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
            
            .status-card {
                padding: 20px;
            }
            
            .status-value {
                font-size: 1.5rem;
            }
            
            .action-grid {
                grid-template-columns: repeat(4, 1fr);
                gap: 15px;
            }
            
            .action-btn {
                min-height: 120px;
                padding: 20px 15px;
            }
            
            .compartment-grid {
                grid-template-columns: repeat(7, 1fr);
                gap: 12px;
            }
            
            .compartment-btn.hole,
            .compartment-btn.calibrate {
                grid-column: span 1;
            }
            
            .manual-buttons {
                grid-template-columns: repeat(8, 1fr);
                gap: 12px;
            }
            
            .manual-btn {
                padding: 15px 10px;
            }
            
            .day-selector {
                gap: 10px;
            }
            
            .day-btn {
                min-width: 45px;
            }
            
            .quick-time-buttons {
                grid-template-columns: repeat(6, 1fr);
                gap: 10px;
            }
        }
        
        @media (min-width: 992px) {
            .app-container {
                max-width: 900px;
            }
        }
        
        /* Landscape Mode Optimization */
        @media (max-height: 600px) and (orientation: landscape) {
            .app-container {
                max-height: 90vh;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .status-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .action-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .compartment-grid {
                grid-template-columns: repeat(7, 1fr);
            }
            
            .medicine-log-container {
                max-height: 300px;
            }
        }
        
        /* Very Small Phones */
        @media (max-width: 360px) {
            .compartment-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .compartment-btn.hole,
            .compartment-btn.calibrate {
                grid-column: span 3;
            }
            
            .action-grid {
                grid-template-columns: 1fr;
            }
            
            .manual-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .day-selector {
                gap: 5px;
            }
            
            .day-btn {
                min-width: 35px;
                font-size: 0.75rem;
                padding: 6px 0;
            }
            
            .quick-time-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .time-display {
                font-size: 1.5rem;
                min-width: 100px;
            }
            
            .schedule-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .schedule-time {
                font-size: 1rem;
            }
            
            .time-control-btn {
                width: 28px;
                height: 28px;
                font-size: 0.9rem;
            }
            
            /* Medicine log table adjustments for small screens */
            .medicine-log-table th,
            .medicine-log-table td {
                padding: 10px 8px;
                font-size: 0.8rem;
            }
            
            .log-timestamp {
                min-width: 120px;
            }
            
            .log-time {
                font-size: 0.75rem;
                padding: 3px 6px;
            }
            
            .log-status {
                font-size: 0.7rem;
                padding: 4px 8px;
            }
            
            /* Modal adjustments for small screens */
            .modal-footer {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
            }
        }
        
        /* Prevent text selection on buttons */
        button {
            user-select: none;
            -webkit-user-select: none;
        }

    </style>
</head>
<body>
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo-icon">
                        <i class="fas fa-pills"></i>
                    </div>
                    <div>
                        <h1 class="app-title">Smart Medicine Dispenser</h1>
                        <p class="app-subtitle">Control Panel</p>
                    </div>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <i class="fas fa-wifi"></i>
                    <span>Connecting...</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Refill Warning Banner -->
            <div class="refill-warning-banner" id="refillWarningBanner">
                <div class="refill-warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="refill-warning-text">
                    <h6>REFILL REQUIRED!</h6>
                    <p>All compartments used. Please refill medicine.</p>
                </div>
                <button class="btn btn-light" onclick="showRefillModal()" style="margin-left: auto; padding: 8px 15px; font-size: 0.85rem; white-space: nowrap;">
                    <i class="fas fa-sync-alt"></i> Refilled
                </button>
            </div>

            <!-- System Status -->
            <div class="status-grid">
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-power-off"></i>
                    </div>
                    <div class="status-label">Status</div>
                    <div class="status-value" id="systemStatus">Offline</div>
                </div>
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                    <div class="status-label">Position</div>
                    <div class="status-value" id="currentPosition">-</div>
                </div>
                <div class="status-card">
                    <div class="status-icon">
                        <i class="fas fa-capsules"></i>
                    </div>
                    <div class="status-label">Doses</div>
                    <div class="status-value" id="doseCount">0</div>
                </div>
                <div class="status-card" id="refillStatusCard">
                    <div class="status-icon">
                        <i class="fas fa-box"></i>
                    </div>
                    <div class="status-label">Remaining</div>
                    <div class="status-value" id="remainingCompartments">7</div>
                </div>
            </div>

            <!-- Calibration Warning -->
            <div id="calibrationWarning" class="warning-banner" style="display: none;">
                <div class="warning-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="warning-text">
                    <h6>System Not Calibrated</h6>
                    <p>Calibrate before first use for accurate dispensing</p>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-bolt"></i>
                </div>
                <h2 class="section-title">Quick Actions</h2>
            </div>
            
            <div class="action-grid">
                <button class="action-btn dispense" onclick="sendCommand('dispense')">
                    <div class="action-icon">
                        <i class="fas fa-capsules"></i>
                    </div>
                    <div class="action-label">Dispense</div>
                </button>
                
                <button class="action-btn sanitizer" onclick="sendCommand('sanitizer')">
                    <div class="action-icon">
                        <i class="fas fa-hand-sparkles"></i>
                    </div>
                    <div class="action-label">Sanitizer</div>
                </button>
                
                <button class="action-btn refill" onclick="showRefillModal()">
                    <div class="action-icon">
                        <i class="fas fa-sync-alt"></i>
                    </div>
                    <div class="action-label">Refill</div>
                </button>
            </div>

            <!-- Manual Movement -->
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-arrows-alt-h"></i>
                </div>
                <h2 class="section-title">Manual Movement</h2>
            </div>
            
            <div class="manual-controls">
                <p class="text-muted mb-3">For precise positioning during calibration</p>
                
                <div class="manual-buttons">
                    <button class="manual-btn" onclick="manualMove(-500)">
                        <div class="manual-icon">
                            <i class="fas fa-fast-backward"></i>
                        </div>
                        <div>-500</div>
                    </button>
                    
                    <button class="manual-btn" onclick="manualMove(-10)">
                        <div class="manual-icon">
                            <i class="fas fa-step-backward"></i>
                        </div>
                        <div>-10</div>
                    </button>
                    
                    <button class="manual-btn" onclick="manualMove(10)">
                        <div class="manual-icon">
                            <i class="fas fa-step-forward"></i>
                        </div>
                        <div>+10</div>
                    </button>
                    
                    <button class="manual-btn" onclick="manualMove(500)">
                        <div class="manual-icon">
                            <i class="fas fa-fast-forward"></i>
                        </div>
                        <div>+500</div>
                    </button>
                </div>
            </div>

            <!-- Calibration Button -->
            <div class="emergency-container">
                <button class="emergency-btn" onclick="showCalibrationModal()">
                    <i class="fas fa-crosshairs"></i>
                    CALIBRATE SYSTEM
                </button>
            </div>

            <!-- Medication Schedule Section -->
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <h2 class="section-title">Medication Schedule</h2>
            </div>

            <!-- Schedule Form Container -->
            <div class="schedule-form-container">
                <!-- IMPROVED: User-Friendly Time Picker -->
                <div class="time-picker-container">
                    <div class="time-picker-header">
                        <div class="time-display" id="timeDisplay">08:00 AM</div>
                    </div>
                    
                    <div class="time-sliders">
                        <!-- Hour Control -->
                        <div class="time-slider-group">
                            <div class="time-slider-label">
                                <span>Hour</span>
                                <span class="value" id="hourValue">8</span>
                                <div class="time-controls">
                                    <button class="time-control-btn" onclick="adjustTime('hour', -1)" title="Decrease hour">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="time-control-btn" onclick="adjustTime('hour', 1)" title="Increase hour">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="range" min="1" max="12" value="8" class="time-slider" id="hourSlider" oninput="updateTimeFromSlider('hour')">
                        </div>
                        
                        <!-- Minute Control -->
                        <div class="time-slider-group">
                            <div class="time-slider-label">
                                <span>Minute</span>
                                <span class="value" id="minuteValue">00</span>
                                <div class="time-controls">
                                    <button class="time-control-btn" onclick="adjustTime('minute', -1)" title="Decrease 5 minutes">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <button class="time-control-btn" onclick="adjustTime('minute', 1)" title="Increase 5 minutes">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <input type="range" min="0" max="55" value="0" step="5" class="time-slider" id="minuteSlider" oninput="updateTimeFromSlider('minute')">
                        </div>
                    </div>
                    
                    <!-- AM/PM Toggle -->
                    <div class="am-pm-toggle">
                        <button class="am-pm-btn active" id="amBtn" onclick="setAmPm('AM')">AM</button>
                        <button class="am-pm-btn" id="pmBtn" onclick="setAmPm('PM')">PM</button>
                    </div>
                </div>

                <!-- Schedule Name Input -->
                <div class="mb-3">
                    <label class="form-label">Schedule Name</label>
                    <input type="text" class="form-control" id="scheduleName" placeholder="e.g., Morning Meds, Evening Pills, Bedtime">
                </div>
                
                <!-- Days Selection - RESPONSIVE FIX -->
                <div class="mb-3">
                    <label class="form-label">Repeat on Days</label>
                    <div class="day-selector">
                        <button type="button" class="day-btn btn-outline-primary" data-day="0" onclick="toggleDay(this)">
                            Sun
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="1" onclick="toggleDay(this)">
                            Mon
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="2" onclick="toggleDay(this)">
                            Tue
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="3" onclick="toggleDay(this)">
                            Wed
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="4" onclick="toggleDay(this)">
                            Thu
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="5" onclick="toggleDay(this)">
                            Fri
                        </button>
                        <button type="button" class="day-btn btn-outline-primary" data-day="6" onclick="toggleDay(this)">
                            Sat
                        </button>
                    </div>
                    
                    <!-- Quick Select Buttons - RESPONSIVE FIX -->
                    <div class="quick-select-buttons">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllDays()">
                            <i class="fas fa-calendar-alt"></i> All Days
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekdays()">
                            <i class="fas fa-briefcase"></i> Weekdays
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectWeekends()">
                            <i class="fas fa-umbrella-beach"></i> Weekends
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="clearDays()">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>
                
                <!-- Schedule Limit Indicator -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <small class="text-muted">Maximum: 10 schedules</small>
                    <small class="text-muted" id="scheduleCountIndicator">0/10 used</small>
                </div>
                
                <!-- Add Schedule Button -->
                <button class="btn btn-primary w-100 py-3 mb-4" onclick="addSchedule()" style="font-size: 1.1rem; font-weight: 600;">
                    <i class="fas fa-plus-circle me-2"></i> Add Medication Schedule
                </button>
                
                <!-- Active Schedules List -->
                <div class="mt-4">
                    <h6 class="mb-3">Active Schedules</h6>
                    <div class="schedules-list" id="schedulesList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Schedules will be displayed here -->
                    </div>
                </div>
                
                <!-- Schedule Status -->
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mt-3 pt-3 border-top">
                    <div class="mb-2 mb-md-0">
                        <span id="schedulerStatus" class="badge bg-danger">Scheduler OFF</span>
                        <!-- <small class="text-muted ms-2 d-block d-md-inline">Will dispense from all compartments</small> -->
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="toggleScheduler()" id="schedulerToggleBtn">
                            <i class="fas fa-play"></i> Turn ON
                        </button>
                        <button class="btn btn-danger" onclick="showClearAllSchedulesModal()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
            </div>

            <!-- ===== CLEAN MEDICATION TAKEN LOG ===== -->
            <div class="section-header">
                <div class="section-icon">
                    <i class="fas fa-history"></i>
                </div>
                <h2 class="section-title">Medicine Taken History</h2>
            </div>
            
            <div class="medicine-log-container">
                <div class="medicine-log-header">
                    <h3 class="medicine-log-title">
                        <i class="fas fa-check-circle"></i>
                        Confirmed Medication Times
                    </h3>
                    <div class="medicine-log-controls">
                        <span class="medicine-log-badge" id="logCount">0 entries</span>
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshMedicineLog()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
                <div class="medicine-log-table-container">
                    <table class="medicine-log-table">
                        <thead>
                            <tr>
                                <th style="width: 40%;">Date & Time</th>
                                <th style="width: 30%;">Details</th>
                                <th style="width: 20%;">Status</th>
                            </tr>
                        </thead>
                        <tbody id="medicineLogTableBody">
                            <!-- Medicine logs will be displayed here -->
                        </tbody>
                    </table>
                </div>
                <div class="no-medicine-log" id="noMedicineLog">
                    <i class="fas fa-history"></i>
                    <p>No medication history found</p>
                    <p class="small text-muted">When medicine is taken and confirmed, it will appear here</p>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="loading-spinner" id="loadingSpinner"></div>
        </main>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Calibration Modal -->
    <div class="confirmation-modal calibration-modal" id="calibrationModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-crosshairs"></i>
                </div>
                <h3 class="modal-title">Calibrate System</h3>
                <p class="modal-subtitle">Set current position as home</p>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    This will reset the system's position reference.<br>
                    <strong>Make sure the dispenser is at the desired home position.</strong><br><br>
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('calibrationModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-primary" onclick="confirmCalibration()">
                    <i class="fas fa-check"></i> Calibrate
                </button>
            </div>
        </div>
    </div>
    
    <!-- Refill Modal -->
    <div class="confirmation-modal refill-modal" id="refillModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-sync-alt"></i>
                </div>
                <h3 class="modal-title">Confirm Medicine Refill</h3>
                <p class="modal-subtitle">Reset all compartments</p>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    This will mark all compartments as refilled and reset the usage counter.<br><br>
                    <strong>Only proceed if you have physically refilled all medicine compartments.</strong>
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('refillModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-warning" onclick="confirmRefill()">
                    <i class="fas fa-check"></i> Confirm Refill
                </button>
            </div>
        </div>
    </div>
    
    <!-- Clear All Schedules Modal -->
    <div class="confirmation-modal clear-schedules-modal" id="clearSchedulesModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-trash"></i>
                </div>
                <h3 class="modal-title">Clear All Schedules</h3>
                <p class="modal-subtitle">Remove all medication schedules</p>
            </div>
            <div class="modal-body">
                <p class="modal-message">
                    This will delete <strong>all</strong> medication schedules permanently.<br><br>
                    <span id="scheduleCountText"></span><br><br>
                    This action cannot be undone.
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('clearSchedulesModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-danger" onclick="confirmClearAllSchedules()">
                    <i class="fas fa-trash"></i> Delete All
                </button>
            </div>
        </div>
    </div>
    
    <!-- Delete Schedule Modal -->
    <div class="confirmation-modal delete-schedule-modal" id="deleteScheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <i class="fas fa-trash"></i>
                </div>
                <h3 class="modal-title">Delete Schedule</h3>
                <p class="modal-subtitle">Remove medication schedule</p>
            </div>
            <div class="modal-body">
                <p class="modal-message" id="deleteScheduleMessage">
                    <!-- Dynamic content will be inserted here -->
                </p>
            </div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeModal('deleteScheduleModal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="modal-btn modal-btn-danger" onclick="confirmDeleteSchedule()">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>




    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBWV2uGQ0UsgtmvCz3_kAIt1AtVnGVdPEQ",
            databaseURL: "https://ctrlstudioz-ec3f7-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // System state
        let isConnected = false;
        let systemStatus = 'unknown';
        let currentPosition = 0;
        let doseCount = 0;
        let isCalibrated = false;
        let isBusy = false;
        let medicationLogs = [];

        // Refill Management
        let usedCompartments = 0;
        let totalCompartments = 7;
        let refillNeeded = false;

        // Schedule Management
        let schedules = [];
        let schedulerEnabled = false;
        let selectedDays = [];
        const MAX_SCHEDULES = 10; // Maximum number of schedules allowed

        // Time Picker State
        let selectedHour = 8;
        let selectedMinute = 0;
        let selectedAmPm = "AM";

        // Modal Management
        let currentScheduleToDelete = null;

        // Real-time update interval
        let realTimeUpdateInterval = null;

        // ==================== MODAL FUNCTIONS ====================
        // Show modal
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'flex';
                // Prevent body scrolling when modal is open
                document.body.style.overflow = 'hidden';
            }
        }

        // Close modal
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.display = 'none';
                // Restore body scrolling
                document.body.style.overflow = 'auto';
            }
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('confirmation-modal')) {
                event.target.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        });

        // Show calibration modal
        function showCalibrationModal() {
            showModal('calibrationModal');
        }

        // Confirm calibration
        function confirmCalibration() {
            sendCommand('calibrate');
            closeModal('calibrationModal');
            showToast('Calibration started...', 'info');
        }

        // Show refill modal
        function showRefillModal() {
            showModal('refillModal');
        }

        // Confirm refill
        function confirmRefill() {
            sendRefillCommand();
            closeModal('refillModal');
        }

        // Show clear all schedules modal
        function showClearAllSchedulesModal() {
            const scheduleCount = schedules.length;
            const scheduleCountText = document.getElementById('scheduleCountText');
            if (scheduleCountText) {
                scheduleCountText.innerHTML = scheduleCount === 0 
                    ? 'No schedules to delete.' 
                    : `You are about to delete <strong>${scheduleCount}</strong> schedule${scheduleCount !== 1 ? 's' : ''}.<br>
                       <small class="text-muted">You can add up to 10 schedules.</small>`;
            }
            showModal('clearSchedulesModal');
        }

        // Confirm clear all schedules
        function confirmClearAllSchedules() {
            schedules = [];
            saveSchedulesToFirebase();
            updateSchedulesDisplay();
            updateScheduleCountIndicator();
            console.log('All schedules cleared');
            showToast('All schedules cleared', 'success');
            closeModal('clearSchedulesModal');
        }

        // Show delete schedule modal
        function showDeleteScheduleModal(scheduleId) {
            const schedule = schedules.find(s => s.id === scheduleId);
            if (!schedule) return;
            
            currentScheduleToDelete = scheduleId;
            const displayTime = formatTimeForDisplay(schedule.time);
            const daysText = getDayNames(schedule.days);
            
            const messageElement = document.getElementById('deleteScheduleMessage');
            if (messageElement) {
                messageElement.innerHTML = `
                    Delete schedule: <strong>${schedule.name}</strong><br>
                    Time: <strong>${displayTime}</strong><br>
                    Days: <strong>${daysText}</strong><br><br>
                    This action cannot be undone.
                `;
            }
            
            showModal('deleteScheduleModal');
        }

        // Confirm delete schedule
        function confirmDeleteSchedule() {
            if (!currentScheduleToDelete) return;
            
            const schedule = schedules.find(s => s.id === currentScheduleToDelete);
            if (schedule) {
                schedules = schedules.filter(s => s.id !== currentScheduleToDelete);
                saveSchedulesToFirebase();
                updateSchedulesDisplay();
                updateScheduleCountIndicator();
                const displayTime = formatTimeForDisplay(schedule.time);
                showToast(`Schedule for ${displayTime} deleted`, 'success');
                console.log(`Schedule deleted: ${schedule.name}`);
            }
            
            closeModal('deleteScheduleModal');
            currentScheduleToDelete = null;
        }

        // ==================== FIREBASE PATH HELPERS ====================
        const BASE_PATH = "SmartMedicine";

        // Helper functions to create paths
        function getFirebasePath(path) {
            return `${BASE_PATH}/${path}`;
        }

        function getCommandPath() {
            return getFirebasePath("command");
        }

        function getCommandTimestampPath() {
            return getFirebasePath("command_timestamp");
        }

        function getCompartmentPath() {
            return getFirebasePath("compartment");
        }

        function getStatusPath() {
            return getFirebasePath("status");
        }

        function getCurrentPath() {
            return getFirebasePath("current");
        }

        function getDosesPath() {
            return getFirebasePath("doses");
        }

        function getLastPath() {
            return getFirebasePath("last");
        }

        function getCalibratedPath() {
            return getFirebasePath("calibrated");
        }

        function getNotificationsActivePath() {
            return getFirebasePath("notifications_active");
        }

        function getLastUpdatePath() {
            return getFirebasePath("lastUpdate");
        }

        function getRefillPath(subpath) {
            return getFirebasePath(`refill/${subpath}`);
        }

        function getSchedulerPath(subpath) {
            return getFirebasePath(`scheduler/${subpath}`);
        }

        function getSchedulesPath(subpath = "") {
            return getFirebasePath(`schedules/${subpath}`);
        }

        function getMedicationTimesPath(subpath = "") {
            return getFirebasePath(`medication_times/${subpath}`);
        }

        function getLatestMedicationTimePath() {
            return getFirebasePath("latest_medication_time");
        }

        // ==================== TIME PICKER FUNCTIONS ====================
        // Initialize time picker
        function initTimePicker() {
            updateTimeDisplay();
            setCurrentTime();
        }

        // Update time display
        function updateTimeDisplay() {
            const hourStr = selectedHour.toString().padStart(2, '0');
            const minuteStr = selectedMinute.toString().padStart(2, '0');
            const timeString = `${hourStr}:${minuteStr} ${selectedAmPm}`;
            
            document.getElementById('timeDisplay').textContent = timeString;
            document.getElementById('hourValue').textContent = selectedHour;
            document.getElementById('minuteValue').textContent = minuteStr;
            
            // Update sliders
            document.getElementById('hourSlider').value = selectedHour;
            document.getElementById('minuteSlider').value = selectedMinute;
            
            // Update AM/PM buttons
            document.getElementById('amBtn').classList.toggle('active', selectedAmPm === 'AM');
            document.getElementById('pmBtn').classList.toggle('active', selectedAmPm === 'PM');
        }

        // Adjust time
        function adjustTime(type, amount) {
            if (type === 'hour') {
                selectedHour += amount;
                if (selectedHour > 12) selectedHour = 1;
                if (selectedHour < 1) selectedHour = 12;
            } else if (type === 'minute') {
                selectedMinute += amount;
                
                // Handle minute overflow
                if (selectedMinute >= 60) {
                    selectedMinute -= 60;
                    selectedHour = (selectedHour % 12) + 1;
                }
                
                // Handle minute underflow
                if (selectedMinute < 0) {
                    selectedMinute += 60;
                    selectedHour = selectedHour === 1 ? 12 : selectedHour - 1;
                }
            }
            
            updateTimeDisplay();
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(20);
        }

        // Update time from slider
        function updateTimeFromSlider(type) {
            if (type === 'hour') {
                selectedHour = parseInt(document.getElementById('hourSlider').value);
            } else if (type === 'minute') {
                selectedMinute = parseInt(document.getElementById('minuteSlider').value);
            }
            
            updateTimeDisplay();
        }

        // Set AM/PM
        function setAmPm(ampm) {
            selectedAmPm = ampm;
            updateTimeDisplay();
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(20);
        }

        // Set quick minutes
        function setQuickMinutes(minutes) {
            selectedMinute = minutes;
            updateTimeDisplay();
            showToast(`Set to ${minutes.toString().padStart(2, '0')} minutes`, 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(20);
        }

        // Set quick time
        function setQuickTime(type) {
            switch(type) {
                case 'morning':
                    selectedHour = 8;
                    selectedMinute = 0;
                    selectedAmPm = 'AM';
                    break;
                case 'noon':
                    selectedHour = 12;
                    selectedMinute = 0;
                    selectedAmPm = 'PM';
                    break;
                case 'evening':
                    selectedHour = 7;
                    selectedMinute = 0;
                    selectedAmPm = 'PM';
                    break;
                case 'current':
                    setCurrentTime();
                    return;
            }
            
            updateTimeDisplay();
            showToast(`Set to ${type} time`, 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        // Set current time
        function setCurrentTime() {
            const now = new Date();
            let hour = now.getHours();
            const minute = Math.floor(now.getMinutes() / 5) * 5; // Round to nearest 5 minutes
            
            selectedAmPm = hour >= 12 ? 'PM' : 'AM';
            hour = hour % 12 || 12; // Convert to 12-hour format
            
            selectedHour = hour;
            selectedMinute = minute;
            
            updateTimeDisplay();
            showToast('Set to current time', 'info');
        }

        // Get formatted time for Firebase
        function getFormattedTime() {
            let hour24 = selectedHour;
            if (selectedAmPm === 'PM' && selectedHour !== 12) {
                hour24 += 12;
            } else if (selectedAmPm === 'AM' && selectedHour === 12) {
                hour24 = 0;
            }
            
            return `${hour24.toString().padStart(2, '0')}:${selectedMinute.toString().padStart(2, '0')}`;
        }

        // ==================== CONNECTION FUNCTIONS ====================
        // Initialize connection
        function initConnection() {
            updateConnectionStatus('Connecting...', false);
            
            // Use a single listener for connection status
            database.ref('.info/connected').on('value', (snapshot) => {
                if (snapshot.val() === true) {
                    isConnected = true;
                    updateConnectionStatus('Connected', true);
                    console.log('Connected to medicine dispenser');
                    startListening();
                    
                    // Load schedules and scheduler status ONCE after connection
                    loadSchedulesFromFirebase();
                    loadSchedulerStatus();
                    loadMedicationLogsFromFirebase(); // Load medication logs
                    
                    // Start real-time updates
                    startRealTimeUpdates();
                } else {
                    isConnected = false;
                    updateConnectionStatus('Disconnected', false);
                    console.log('Connection lost');
                    
                    // Stop real-time updates
                    stopRealTimeUpdates();
                }
            });
        }

        // Start listening to Firebase data
        function startListening() {
            // Use specific paths with base path
            database.ref(getStatusPath()).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const status = snapshot.val();
                    updateSystemState({ status: status });
                }
            });
            
            database.ref(getCurrentPath()).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const current = snapshot.val();
                    updateSystemState({ current: current });
                }
            });
            
            database.ref(getDosesPath()).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const doses = snapshot.val();
                    updateSystemState({ doses: doses });
                }
            });
            
            database.ref(getCalibratedPath()).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const calibrated = snapshot.val();
                    updateSystemState({ calibrated: calibrated });
                }
            });
            
            // Add refill status listeners
            database.ref(getRefillPath("used_count")).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    usedCompartments = snapshot.val();
                    updateRefillDisplay();
                }
            });
            
            database.ref(getRefillPath("needed")).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    refillNeeded = snapshot.val();
                    updateRefillDisplay();
                }
            });
            
            database.ref(getRefillPath("remaining")).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    updateRefillDisplay();
                }
            });
            
            // Add a listener for scheduler status changes from other devices
            database.ref(getSchedulerPath("enabled")).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    const newStatus = snapshot.val();
                    // Only update if it's different from current status
                    if (newStatus !== schedulerEnabled) {
                        schedulerEnabled = newStatus;
                        updateSchedulerUI();
                        console.log('Scheduler status updated from another device:', schedulerEnabled);
                    }
                }
            });
            
            // Listen to medication times for real-time updates
            database.ref(getMedicationTimesPath()).on('value', (snapshot) => {
                if (snapshot.exists()) {
                    console.log('Medication times updated in real-time');
                    loadMedicationLogsFromFirebase();
                }
            });
            
            // Also listen for latest medication time for real-time updates
            database.ref(getLatestMedicationTimePath()).on('value', (snapshot) => {
                if (snapshot.exists() && snapshot.val() !== "None") {
                    console.log('New medication time detected');
                    loadMedicationLogsFromFirebase();
                }
            });
        }

        // Start real-time updates for medication logs
        function startRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            // Update every 10 seconds for real-time updates
            realTimeUpdateInterval = setInterval(() => {
                loadMedicationLogsFromFirebase();
            }, 10000);
        }

        // Stop real-time updates
        function stopRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
                realTimeUpdateInterval = null;
            }
        }

        // Update system state from Firebase
        function updateSystemState(data) {
            // Update status
            if (data.status) {
                systemStatus = data.status;
                const statusElement = document.getElementById('systemStatus');
                statusElement.textContent = 
                    data.status === 'ready' ? 'Ready' : 
                    data.status === 'busy' ? 'Busy' : 
                    data.status === 'moving' ? 'Moving' : data.status;
                statusElement.style.color = 
                    data.status === 'ready' ? '#4cc9f0' : 
                    data.status === 'busy' ? '#ff9a00' : '#ff6b6b';
                
                isBusy = data.status === 'busy' || data.status === 'moving' || data.status === 'dispensing';
            }

            // Update current compartment
            if (data.current !== undefined) {
                currentPosition = data.current;
                const positionText = data.current === 0 ? 'Home' : 
                                   data.current === 8 ? 'Home' : 
                                   `Comp ${data.current}`;
                document.getElementById('currentPosition').textContent = positionText;
            }

            // Update dose count
            // if (data.doses !== undefined) {
            //     doseCount = data.doses;
            //     document.getElementById('doseCount').textContent = data.doses;
            // }

            // Update calibration status
            if (data.calibrated !== undefined) {
                isCalibrated = data.calibrated;
                const warningElement = document.getElementById('calibrationWarning');
                warningElement.style.display = data.calibrated ? 'none' : 'flex';
            }
        }

        // Update refill display
        function updateRefillDisplay() {
            const remaining = totalCompartments - usedCompartments;
            const remainingElement = document.getElementById('remainingCompartments');
            const warningElement = document.getElementById('refillWarningBanner');
            const refillStatusCard = document.getElementById('refillStatusCard');
            
            if (remainingElement) {
                remainingElement.textContent = remaining;
                remainingElement.style.color = remaining <= 2 ? '#ff6b6b' : 
                                              remaining <= 4 ? '#ff9a00' : '#4cc9f0';
            }
            
            if (refillStatusCard) {
                refillStatusCard.style.borderLeftColor = remaining <= 2 ? '#ff6b6b' : 
                                                       remaining <= 4 ? '#ff9a00' : '#4361ee';
            }
            
            if (warningElement) {
                if (refillNeeded) {
                    warningElement.style.display = 'flex';
                    
                    // Show notification if not already shown
                    if (!window.refillNotificationShown) {
                        showToast('URGENT: Refill required! All compartments used.', 'error');
                        window.refillNotificationShown = true;
                    }
                } else {
                    warningElement.style.display = 'none';
                    window.refillNotificationShown = false;
                }
            }
        }

        // Update connection status
        function updateConnectionStatus(message, connected) {
            const statusElement = document.getElementById('connectionStatus');
            
            if (connected) {
                statusElement.style.background = 'rgba(76, 201, 240, 0.3)';
                statusElement.innerHTML = `<i class="fas fa-wifi"></i> <span>${message}</span>`;
            } else {
                statusElement.style.background = 'rgba(255, 107, 107, 0.3)';
                statusElement.innerHTML = `<i class="fas fa-wifi-slash"></i> <span>${message}</span>`;
            }
        }

        // ==================== COMMAND FUNCTIONS ====================
        // Send command to dispenser
        function sendCommand(command, compartment = 0) {
            if (!isConnected) {
                showToast('Connection Error', 'danger');
                return;
            }

            if (isBusy && command !== 'status') {
                showToast('System Busy', 'warning');
                return;
            }

            const timestamp = Date.now();
            const uniqueTimestamp = timestamp + Math.floor(Math.random() * 1000);
            
            showLoading(true);
            
            console.log(`Sending command: ${command}${compartment ? ' (Target: ' + (compartment === 0 ? 'Home' : 'Comp ' + compartment) + ')' : ''}`);

            // Use paths with base path
            const updates = {};
            updates[getCommandPath()] = command;
            updates[getCompartmentPath()] = compartment;
            updates[getCommandTimestampPath()] = uniqueTimestamp;
            
            database.ref().update(updates)
                .then(() => {
                    console.log(`Command sent: ${command}`);
                    showLoading(false);
                    showToast('Command Sent', 'success');
                    
                    // Vibrate on success (mobile only)
                    if (navigator.vibrate) {
                        navigator.vibrate(50);
                    }
                    
                    // Clear command after 1 second
                    setTimeout(() => {
                        if (isConnected) {
                            const clearUpdates = {};
                            clearUpdates[getCommandPath()] = "idle";
                            clearUpdates[getCompartmentPath()] = 0;
                            clearUpdates[getCommandTimestampPath()] = 0;
                            
                            database.ref().update(clearUpdates);
                        }
                    }, 1000);
                    
                })
                .catch((error) => {
                    console.error(`Error: ${error.message}`);
                    showLoading(false);
                    showToast('Command Failed', 'danger');
                });
        }

        // Send refill command
        function sendRefillCommand() {
            if (!isConnected) {
                showToast('Not connected', 'error');
                return;
            }
            
            const timestamp = Date.now();
            
            const updates = {};
            updates[getCommandPath()] = 'refill';
            updates[getCommandTimestampPath()] = timestamp;
            
            // Also clear the last dispensed compartment in Firebase
            updates[getLastPath()] = 0;
            
            database.ref().update(updates)
                .then(() => {
                    showToast('Refill confirmed! Counter reset.', 'success');
                    console.log('Medicine refilled - all compartments reset');
                    
                    // Also update the UI to show last dispensed as cleared
                    console.log('Last dispensed compartment cleared');
                    
                    // Reset refill notification flag
                    window.refillNotificationShown = false;
                    
                    // Clear command after sending
                    setTimeout(() => {
                        if (isConnected) {
                            const clearUpdates = {};
                            clearUpdates[getCommandPath()] = "idle";
                            clearUpdates[getCommandTimestampPath()] = 0;
                            
                            database.ref().update(clearUpdates);
                        }
                    }, 1000);
                })
                .catch((error) => {
                    showToast('Refill command failed', 'error');
                    console.error(`Refill error: ${error.message}`);
                });
        }

        // Manual movement for calibration
        function manualMove(steps) {
            if (!isConnected) {
                return;
            }
            
            console.log(`Manual move: ${steps > 0 ? '+' : ''}${steps} steps`);
            
            // Button feedback vibration
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
            
            // Send manual move command
            sendCommand('goto', steps);
        }

        // ==================== MEDICATION LOG FUNCTIONS ====================
        // Load medication logs from Firebase
        function loadMedicationLogsFromFirebase() {
            if (!isConnected) return;
            
            console.log('Loading medication logs from Firebase...');
            
            database.ref(getMedicationTimesPath()).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        medicationLogs = [];
                        
                        // Convert Firebase data to medication log entries
                        Object.keys(data).forEach(key => {
                            if (key.startsWith('log_')) {
                                const dateTimeString = data[key];
                                
                                // Check if this is a simple string (timestamp from ESP32)
                                if (typeof dateTimeString === 'string' && dateTimeString !== "None") {
                                    // Parse the date/time string from ESP32: "YYYY-MM-DD HH:MM:SS"
                                    const dateTime = new Date(dateTimeString.replace(' ', 'T'));
                                    
                                    if (!isNaN(dateTime.getTime())) {
                                        // Format for display
                                        const dateOptions = { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' };
                                        const timeOptions = { hour: '2-digit', minute: '2-digit' };
                                        
                                        const displayDate = dateTime.toLocaleDateString('en-US', dateOptions);
                                        const displayTime = dateTime.toLocaleTimeString('en-US', timeOptions);
                                        const daysAgo = calculateDaysAgo(dateTime);
                                        
                                        const logEntry = {
                                            id: key,
                                            dateTime: dateTime,
                                            displayDate: displayDate,
                                            displayTime: displayTime,
                                            daysAgo: daysAgo,
                                            timestamp: dateTimeString,
                                            rawTime: dateTime.getTime()
                                        };
                                        medicationLogs.push(logEntry);
                                    }
                                }
                            }
                        });
                        
                        // Sort by timestamp (newest first)
                        medicationLogs.sort((a, b) => b.rawTime - a.rawTime);
                        
                        // Update the UI
                        updateMedicationLogDisplay();
                        
                        // Update doses count
                        updateDosesCount();
                        
                        console.log(`Loaded ${medicationLogs.length} medication logs`);
                    } else {
                        medicationLogs = [];
                        updateMedicationLogDisplay();
                        console.log('No medication logs found in Firebase');
                    }
                })
                .catch((error) => {
                    console.error('Error loading medication logs:', error);
                    showToast('Error loading medication history', 'error');
                });
        }

        // Update doses count based on medication logs
        function updateDosesCount() {
            const doseCountElement = document.getElementById('doseCount');
            if (doseCountElement) {
                doseCountElement.textContent = medicationLogs.length || 0;
            }
        }

        // Calculate how many days ago
        function calculateDaysAgo(dateTime) {
            const now = new Date();
            const diffTime = Math.abs(now - dateTime);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) {
                return 'Today';
            } else if (diffDays === 1) {
                return 'Yesterday';
            } else if (diffDays < 7) {
                return `${diffDays} days ago`;
            } else if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return `${weeks} week${weeks > 1 ? 's' : ''} ago`;
            } else {
                return 'Older';
            }
        }

        // Update medication log display
        function updateMedicationLogDisplay() {
            const tableBody = document.getElementById('medicineLogTableBody');
            const noLogElement = document.getElementById('noMedicineLog');
            const logCountElement = document.getElementById('logCount');
            
            if (!medicationLogs || medicationLogs.length === 0) {
                if (tableBody) tableBody.innerHTML = '';
                if (noLogElement) noLogElement.style.display = 'block';
                if (logCountElement) logCountElement.textContent = '0 entries';
                return;
            }
            
            // Hide the "no logs" message
            if (noLogElement) {
                noLogElement.style.display = 'none';
            }
            
            // Update log count
            if (logCountElement) {
                logCountElement.textContent = `${medicationLogs.length} entr${medicationLogs.length !== 1 ? 'ies' : 'y'}`;
            }

            // Update doses count
            updateDosesCount();
            
            // Build table rows
            let tableHTML = '';
            
            medicationLogs.forEach(log => {
                tableHTML += `
                <tr>
                    <td class="log-timestamp">
                        <strong>${log.displayDate}</strong><br>
                        <span class="log-time">${log.displayTime}</span>
                    </td>
                    <td class="log-time-details">
                        <div class="log-day">${log.dateTime.toLocaleDateString('en-US', { weekday: 'long' })}</div>
                        <small>Confirmed with button press</small>
                    </td>
                    <td>
                        <span class="log-status">Taken</span>
                    </td>
                </tr>
                `;
            });
            
            if (tableBody) {
                tableBody.innerHTML = tableHTML;
            }
        }

        // Refresh medication log
        function refreshMedicineLog() {
            loadMedicationLogsFromFirebase();
            showToast('Medication history refreshed', 'info');
            
            // Button feedback vibration
            if (navigator.vibrate) {
                navigator.vibrate(30);
            }
        }

        // ==================== UTILITY FUNCTIONS ====================
        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            spinner.style.display = show ? 'block' : 'none';
        }

        // Show toast notification
        function showToast(message, type) {
            // Remove existing toasts
            const existingToast = document.querySelector('.mobile-toast');
            if (existingToast) {
                existingToast.remove();
            }
            
            const colors = {
                success: '#4cc9f0',
                error: '#ff6b6b',
                warning: '#ff9a00',
                info: '#4361ee'
            };
            
            const toast = document.createElement('div');
            toast.className = 'mobile-toast';
            toast.innerHTML = `
                <div style="
                    position: fixed;
                    bottom: 20px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: ${colors[type] || colors.info};
                    color: white;
                    padding: 12px 24px;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 0.9rem;
                    z-index: 9999;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    animation: slideUp 0.3s ease;
                ">
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Auto-remove after 2 seconds
            setTimeout(() => {
                toast.remove();
            }, 2000);
        }

        // ==================== SCHEDULE FUNCTIONS ====================

        // Initialize day selector
        function initDaySelector() {
            // Start with NO days selected by default
            selectedDays = [];
            updateDayButtons();
        }

        // Toggle day selection
        function toggleDay(button) {
            const day = parseInt(button.dataset.day);
            const index = selectedDays.indexOf(day);
            
            if (index === -1) {
                selectedDays.push(day);
                button.classList.remove('btn-outline-primary');
                button.classList.add('btn-primary');
                // Add visual feedback for selection
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            } else {
                selectedDays.splice(index, 1);
                button.classList.remove('btn-primary');
                button.classList.add('btn-outline-primary');
                // Add visual feedback for deselection
                button.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    button.style.transform = '';
                }, 150);
            }
            
            // Sort days for consistent display
            selectedDays.sort((a, b) => a - b);
            
            // Button feedback vibration
            if (navigator.vibrate) {
                navigator.vibrate(20);
            }
        }

        // Quick select functions
        function selectAllDays() {
            selectedDays = [0, 1, 2, 3, 4, 5, 6];
            updateDayButtons();
            console.log('Selected: All days');
            showToast('All days selected', 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function selectWeekdays() {
            selectedDays = [1, 2, 3, 4, 5];
            updateDayButtons();
            console.log('Selected: Weekdays');
            showToast('Weekdays selected', 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function selectWeekends() {
            selectedDays = [0, 6];
            updateDayButtons();
            console.log('Selected: Weekends');
            showToast('Weekends selected', 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function clearDays() {
            selectedDays = [];
            updateDayButtons();
            console.log('Cleared all days');
            showToast('All days cleared', 'info');
            
            // Vibrate for feedback
            if (navigator.vibrate) navigator.vibrate(30);
        }

        function updateDayButtons() {
            document.querySelectorAll('.day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (selectedDays.includes(day)) {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('btn-primary');
                    btn.style.borderWidth = '2px';
                    btn.style.borderColor = 'var(--primary)';
                } else {
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                    btn.style.borderWidth = '2px';
                }
            });
        }

        // Update schedule count indicator
        function updateScheduleCountIndicator() {
            const indicator = document.getElementById('scheduleCountIndicator');
            if (indicator) {
                indicator.textContent = `${schedules.length}/${MAX_SCHEDULES} used`;
                
                // Change color based on usage
                if (schedules.length >= MAX_SCHEDULES) {
                    indicator.className = 'text-danger fw-bold';
                } else if (schedules.length >= 7) {
                    indicator.className = 'text-warning';
                } else {
                    indicator.className = 'text-muted';
                }
            }
        }

        // Add schedule
        function addSchedule() {
            // Check if schedule limit is reached
            if (schedules.length >= MAX_SCHEDULES) {
                showToast('Schedule limit reached (max 10)', 'error');
                
                // Add visual feedback to indicate limit reached
                const addButton = document.querySelector('[onclick="addSchedule()"]');
                addButton.style.backgroundColor = '#ff6b6b';
                addButton.style.color = 'white';
                addButton.innerHTML = '<i class="fas fa-ban me-2"></i> Limit Reached (10)';
                
                setTimeout(() => {
                    addButton.style.backgroundColor = '';
                    addButton.style.color = '';
                    addButton.innerHTML = '<i class="fas fa-plus-circle me-2"></i> Add Medication Schedule';
                }, 2000);
                
                // Button feedback vibration (error pattern)
                if (navigator.vibrate) {
                    navigator.vibrate([100, 50, 100]);
                }
                return;
            }
            
            const name = document.getElementById('scheduleName').value.trim() || "Medication";
            const time = getFormattedTime();
            
            if (selectedDays.length === 0) {
                showToast('Please select at least one day', 'error');
                // Add visual feedback to day selector
                const daySelector = document.querySelector('.day-selector');
                daySelector.style.border = '2px dashed var(--danger)';
                daySelector.style.padding = '8px';
                daySelector.style.borderRadius = '8px';
                setTimeout(() => {
                    daySelector.style.border = '';
                    daySelector.style.padding = '';
                }, 2000);
                return;
            }
            
            // Create new schedule
            const schedule = {
                id: Date.now() + Math.floor(Math.random() * 1000), // Ensure unique ID
                name: name,
                time: time,
                days: [...selectedDays], // Copy the array
                active: true
            };
            
            // Add to schedules array
            schedules.push(schedule);
            
            // Save to Firebase
            saveSchedulesToFirebase();
            
            // Update display with remaining count
            updateSchedulesDisplay();
            updateScheduleCountIndicator();
            
            // Show success message with remaining schedule count
            const daysText = getDayNames(selectedDays);
            const displayTime = formatTimeForDisplay(time);
            const remainingSchedules = MAX_SCHEDULES - schedules.length;
            
            let successMessage = `Schedule added: ${displayTime} on ${daysText}`;
            if (remainingSchedules > 0) {
                successMessage += ` (${remainingSchedules} schedule${remainingSchedules !== 1 ? 's' : ''} remaining)`;
            } else {
                successMessage += ' (Maximum reached)';
            }
            
            showToast(successMessage, 'success');
            console.log(`Added schedule: ${name} at ${displayTime} (${daysText})`);
            
            // Clear form with visual feedback
            const scheduleNameInput = document.getElementById('scheduleName');
            
            // Visual feedback for clearing
            scheduleNameInput.style.opacity = '0.5';
            
            setTimeout(() => {
                scheduleNameInput.value = '';
                scheduleNameInput.style.opacity = '1';
                initDaySelector(); // Reset to default (no days selected)
                
                // Button feedback vibration
                if (navigator.vibrate) {
                    navigator.vibrate(30);
                }
            }, 300);
        }

        // Format time for display (12-hour format)
        function formatTimeForDisplay(time24) {
            const [hours, minutes] = time24.split(':');
            const hour = parseInt(hours);
            const minute = parseInt(minutes);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minute.toString().padStart(2, '0')} ${ampm}`;
        }

        // Update schedules display WITHOUT badges
        function updateSchedulesDisplay() {
            const container = document.getElementById('schedulesList');
            
            if (!schedules || schedules.length === 0) {
                container.innerHTML = `
                    <div class="no-schedules">
                        <i class="fas fa-calendar-plus fa-2x mb-3"></i>
                        <p>No schedules added yet</p>
                        <p class="small">Add your first medication schedule above</p>
                        <p class="small text-muted">Select days and time, then click "Add Schedule"</p>
                        <div class="mt-3">
                            <span class="badge bg-light text-dark">Maximum: ${MAX_SCHEDULES} schedules</span>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Sort schedules by time
            const sortedSchedules = [...schedules].sort((a, b) => {
                return a.time.localeCompare(b.time);
            });
            
            // Add a header showing total schedules and remaining
            const remainingSchedules = MAX_SCHEDULES - schedules.length;
            const headerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <small class="text-muted">
                        ${schedules.length} schedule${schedules.length !== 1 ? 's' : ''} configured
                        ${remainingSchedules > 0 ? `(${remainingSchedules} remaining)` : '(Maximum reached)'}
                    </small>
                    ${remainingSchedules === 0 ? 
                        '<span class="badge bg-danger"><i class="fas fa-ban me-1"></i> Max Reached</span>' : 
                        ''}
                </div>
            `;
            
            container.innerHTML = headerHTML + sortedSchedules.map(schedule => {
                const daysText = getDayNames(schedule.days);
                const displayTime = formatTimeForDisplay(schedule.time);
                
                return `
                <div class="schedule-item ${schedule.active ? 'active-schedule' : 'inactive-schedule'}">
                    <div class="schedule-header">
                        <span class="schedule-name">
                            <i class="fas fa-clock me-2 ${schedule.active ? 'text-primary' : 'text-secondary'}"></i>
                            ${schedule.name}
                        </span>
                        <span class="schedule-time ${schedule.active ? 'text-primary' : 'text-secondary'}">
                            ${displayTime}
                        </span>
                    </div>
                    <div class="schedule-details">
                        <span class="schedule-days">
                            <i class="fas fa-calendar-day"></i>
                            ${daysText}
                        </span>
                        <span class="schedule-status-badge ${schedule.active ? 'active' : 'inactive'}">
                            ${schedule.active ? 'Active' : 'Inactive'}
                        </span>
                    </div>
                    <div class="schedule-actions">
                        <button class="btn btn-sm ${schedule.active ? 'btn-warning' : 'btn-success'}" 
                                onclick="toggleSchedule(${schedule.id})">
                            <i class="fas ${schedule.active ? 'fa-pause' : 'fa-play'}"></i>
                            ${schedule.active ? 'Pause' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="showDeleteScheduleModal(${schedule.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
                `;
            }).join('');
            
            // Update schedule count indicator
            updateScheduleCountIndicator();
        }

        // Get day names from numbers
        function getDayNames(dayNumbers) {
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            if (!dayNumbers || dayNumbers.length === 0) return 'No days';
            if (dayNumbers.length === 7) return 'Every day';
            if (JSON.stringify(dayNumbers.sort()) === JSON.stringify([1,2,3,4,5])) return 'Weekdays';
            if (JSON.stringify(dayNumbers.sort()) === JSON.stringify([0,6])) return 'Weekends';
            
            return dayNumbers.sort().map(d => dayNames[d]).join(', ');
        }

        // Toggle schedule active/inactive
        function toggleSchedule(scheduleId) {
            const scheduleIndex = schedules.findIndex(s => s.id === scheduleId);
            if (scheduleIndex !== -1) {
                schedules[scheduleIndex].active = !schedules[scheduleIndex].active;
                saveSchedulesToFirebase();
                updateSchedulesDisplay();
                const status = schedules[scheduleIndex].active ? 'activated' : 'paused';
                showToast(`Schedule ${status}`, 'info');
                console.log(`Schedule ${schedules[scheduleIndex].name} ${status}`);
            }
        }

        // Delete schedule (now uses modal)
        function deleteSchedule(scheduleId) {
            // This function is now handled by the modal
            showDeleteScheduleModal(scheduleId);
        }

        // Toggle scheduler
        function toggleScheduler() {
            // Toggle the local variable first
            schedulerEnabled = !schedulerEnabled;
            
            // Update UI immediately for better UX
            updateSchedulerUI();
            
            // Save to Firebase
            saveSchedulerStatus();
            
            // Show feedback
            if (schedulerEnabled) {
                console.log('Scheduler enabled');
                showToast('Scheduler is now ACTIVE', 'success');
                
                // If this is the first time enabling, show instructions
                if (schedules.length === 0) {
                    showToast('Add schedules below to start automated dispensing', 'info');
                }
            } else {
                console.log('Scheduler disabled');
                showToast('Scheduler is now INACTIVE', 'warning');
            }
            
            // Button feedback vibration
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        // Clear all schedules (now uses modal)
        function clearAllSchedules() {
            // This function is now handled by the modal
            showClearAllSchedulesModal();
        }

        // Save schedules to Firebase
        function saveSchedulesToFirebase() {
            if (!isConnected) return;
            
            // Save schedules under the base path
            database.ref(getSchedulesPath()).set(schedules)
                .then(() => {
                    console.log('Schedules saved to Firebase successfully');
                })
                .catch((error) => {
                    console.error('Error saving schedules:', error);
                    showToast('Error saving schedules', 'error');
                });
        }

        // Save scheduler status to Firebase
        function saveSchedulerStatus() {
            if (!isConnected) return;
            
            console.log('Saving scheduler status:', schedulerEnabled);
            
            database.ref(getSchedulerPath("")).set({
                enabled: schedulerEnabled,
                lastUpdated: Date.now()
            }).then(() => {
                console.log('Scheduler status saved successfully');
            }).catch((error) => {
                console.error('Error saving scheduler status:', error);
                showToast('Error saving scheduler status', 'error');
            });
        }

        // Load schedules from Firebase
        function loadSchedulesFromFirebase() {
            if (!isConnected) return;
            
            database.ref(getSchedulesPath()).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        if (Array.isArray(data)) {
                            schedules = data;
                        } else if (typeof data === 'object') {
                            schedules = Object.values(data);
                        } else {
                            schedules = [];
                        }
                        updateSchedulesDisplay();
                        updateScheduleCountIndicator();
                        console.log(`Loaded ${schedules.length} schedules`);
                    } else {
                        schedules = [];
                        updateSchedulesDisplay();
                        updateScheduleCountIndicator();
                        console.log('No schedules found in Firebase');
                    }
                })
                .catch((error) => {
                    console.error('Error loading schedules:', error);
                    showToast('Error loading schedules', 'error');
                });
        }

        // Load scheduler status from Firebase
        function loadSchedulerStatus() {
            if (!isConnected) return;
            
            // Use once() instead of on() to get a single snapshot
            database.ref(getSchedulerPath("enabled")).once('value')
                .then((snapshot) => {
                    if (snapshot.exists()) {
                        schedulerEnabled = snapshot.val();
                        console.log('Loaded scheduler status:', schedulerEnabled);
                        updateSchedulerUI();
                        console.log(`Scheduler ${schedulerEnabled ? 'ON' : 'OFF'}`);
                    } else {
                        // If no scheduler status exists, set default to false
                        schedulerEnabled = false;
                        saveSchedulerStatus(); // Save the default status
                        updateSchedulerUI();
                        console.log('No scheduler status found, setting default OFF');
                    }
                })
                .catch((error) => {
                    console.error('Error loading scheduler status:', error);
                    showToast('Error loading scheduler status', 'error');
                });
        }

        // Update scheduler UI based on status
        function updateSchedulerUI() {
            const statusBadge = document.getElementById('schedulerStatus');
            const toggleBtn = document.getElementById('schedulerToggleBtn');
            
            if (schedulerEnabled) {
                statusBadge.className = 'badge bg-success';
                statusBadge.textContent = 'Scheduler ON';
                toggleBtn.innerHTML = '<i class="fas fa-stop"></i> Turn OFF';
                toggleBtn.className = 'btn btn-warning';
            } else {
                statusBadge.className = 'badge bg-danger';
                statusBadge.textContent = 'Scheduler OFF';
                toggleBtn.innerHTML = '<i class="fas fa-play"></i> Turn ON';
                toggleBtn.className = 'btn btn-success';
            }
        }

        // ==================== INITIALIZATION ====================

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initConnection();
            initDaySelector();
            initTimePicker();
            console.log('Medicine dispenser control panel started');
            
            // Initialize refill notification flag
            window.refillNotificationShown = false;
            
            // Add touch feedback to all buttons
            const buttons = document.querySelectorAll('button');
            buttons.forEach(button => {
                button.addEventListener('touchstart', function() {
                    this.style.opacity = '0.8';
                });
                
                button.addEventListener('touchend', function() {
                    this.style.opacity = '1';
                });
            });
            
            // Prevent zoom on double-tap
            document.addEventListener('dblclick', function(e) {
                e.preventDefault();
            }, { passive: false });
        });

        // Handle orientation change
        window.addEventListener('orientationchange', function() {
            setTimeout(() => {
                window.scrollTo(0, 0);
                updateSchedulesDisplay(); // Update layout on orientation change
            }, 100);
        });
        
        // Prevent pull-to-refresh on mobile
        document.addEventListener('touchmove', function(e) {
            if (e.touches.length > 1) {
                e.preventDefault();
            }
        }, { passive: false });
    </script>
</body>
</html>